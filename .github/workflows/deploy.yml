name: Linode Deploy

on:
  push:
    branches: [ main ]

  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:

    - name: Checkout
      uses: actions/checkout@v4

    - name: Install Terraform
      uses: hashicorp/setup-terraform@v3

    - name: Terraform Init
      working-directory: terraform
      run: terraform init

    - name: Terraform Apply
      working-directory: terraform
      run: |
        terraform apply -auto-approve \
        -var "linode_token=${{ secrets.LINODE_TOKEN }}" \
        -var "ssh_public_key=${{ secrets.SSH_PUBLIC_KEY }}"

    - name: Install jq
      run: sudo apt-get install -y jq

    - name: Generate Ansible Inventory
      working-directory: scripts
      run: |
        cd ../terraform
        bash ../scripts/generate_inventory.sh

    - name: Install Ansible
      run: sudo apt-get install -y ansible

    - name: Setup SSH key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa

    - name: Run Ansible
      working-directory: ansible
      run: ansible-playbook playbooks/site.yml
